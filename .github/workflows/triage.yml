name: Triage & Greeting

on:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, reopened]

permissions:
  issues: write
  pull-requests: write

jobs:
  pr-greeting:
    name: PR Greeting
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Thank you for your contribution! cc @plazen/reviewers @andrinoff'
            })

  issue-triage:
    name: Issue Triage
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-label Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            const title = context.payload.issue.title.toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();
            const labelsToAdd = [];

            if (title.includes('bug') || body.includes('bug') || title.includes('error') || title.includes('fail')) {
              labelsToAdd.push('bug');
            }
            if (title.includes('feat') || title.includes('enhancement') || body.includes('feature')) {
              labelsToAdd.push('enhancement');
            }
            if (title.includes('doc') || body.includes('documentation') || title.includes('typo')) {
              labelsToAdd.push('documentation');
            }

            if (labelsToAdd.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: labelsToAdd
                });
              } catch (error) {
                console.log('Error adding labels', error);
              }
            }

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Thank you for leaving this issue! If possible, we have tried to apply relevant labels. cc @plazen/maintainers'
            })
