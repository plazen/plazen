# This workflow automates versioning and GitHub Releases using semantic-release.
# It runs only on the 'main' branch after tests have passed.

name: Release

on:
  workflow_dispatch:

permissions:
  contents: write # To create releases, tags, and commit version bumps
  issues: write # To comment on issues
  pull-requests: write # To comment on pull requests

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    if: |
      ${{ github.event.head_commit.message != 'chore(release): cut new release' &&
      github.event.head_commit.message != 'chore(release): initial release' }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: "npm"

      - name: üîß Install dependencies
        run: npm ci
      - name: üß™ Run tests
        run: npm test
      # - name: Build project
      #   run: npm run build

      - name: üöÄ Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        with:
          branches: |
            [
              'main'
            ]
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: üîÅ Trigger Vercel deployment
        if: ${{ success() }}
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          if [ -n "$VERCEL_DEPLOY_HOOK" ]; then
            echo "Triggering Vercel deployment hook..."
            # POST to the Vercel deployment hook URL stored in the repository secrets.
            # The hook URL is expected to be set in the secret `VERCEL_DEPLOY_HOOK`.
            curl -sSf -X POST "$VERCEL_DEPLOY_HOOK"
            echo "Vercel deployment hook triggered."
          else
            echo "Skipping Vercel deployment: secret VERCEL_DEPLOY_HOOK not set."
          fi
